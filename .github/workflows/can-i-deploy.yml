name: Can-I-Deploy Demo

on:
  workflow_dispatch:

jobs:
  breaking-change-demo:
    name: Breaking Change Detection
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      cvt-server:
        image: ghcr.io/${{ github.repository_owner }}/cvt-server:0.1.0-alpha.1
        ports:
          - 9550:9550
        options: >-
          --health-cmd "/bin/grpc_health_probe -addr=:9550"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tooling
        uses: ./.github/actions/setup-tooling

      - name: Setup CVT SDK
        uses: ./.github/actions/setup-cvt-sdk
        with:
          repository-owner: ${{ github.repository_owner }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for CVT Server
        uses: ./.github/actions/wait-for-services

      - name: Step 1 - Register Consumers
        id: register
        run: |
          echo "============================================"
          echo "Step 1: Registering consumers with CVT"
          echo "============================================"
          echo ""

          # Run consumer registration tests to register their endpoint usage
          echo "Registering consumer-1 (Node.js)..."
          cd consumer-1 && CVT_ENVIRONMENT=demo npm test -- --testPathPattern=registration --silent 2>&1 || true
          cd ..

          echo ""
          echo "Registering consumer-2 (Python)..."
          cd consumer-2 && CVT_ENVIRONMENT=demo uv run pytest tests/test_registration.py -v 2>&1 || true
          cd ..

          echo ""
          echo "Consumers registered successfully!"

      - name: Step 2 - Register Breaking Schema v2.0.0
        id: register_v2
        run: |
          echo "============================================"
          echo "Step 2: Registering breaking schema v2.0.0"
          echo "============================================"
          echo ""
          echo "The v2.0.0 schema changes 'result' field to 'value'"
          echo ""

          cd consumer-2
          uv run python -c "
          from cvt_sdk import ContractValidator

          validator = ContractValidator('localhost:9550')
          validator.register_schema('calculator-api', '../producer/calculator-api-v2-breaking.yaml')
          print('v2.0.0 breaking schema registered successfully!')
          validator.close()
          "

      - name: Step 3 - Can I Deploy Check
        id: demo
        run: |
          set -o pipefail
          echo "============================================"
          echo "Step 3: Running can-i-deploy check"
          echo "============================================"
          echo ""
          echo "Checking if calculator-api v2.0.0 can be deployed to 'demo' environment..."
          echo ""

          cd consumer-2
          uv run python -c "
          import json
          from cvt_sdk import ContractValidator

          validator = ContractValidator('localhost:9550')

          # Check if v2.0.0 can be deployed
          result = validator.can_i_deploy('calculator-api', '2.0.0', 'demo')

          print('=' * 60)
          print('CAN-I-DEPLOY RESULT')
          print('=' * 60)
          print(f'Schema: calculator-api')
          print(f'Version: 2.0.0')
          print(f'Environment: demo')
          print(f'Safe to deploy: {result.get(\"safe_to_deploy\", \"unknown\")}')
          print()

          if not result.get('safe_to_deploy', True):
              print('BREAKING CHANGES DETECTED!')
              print()
              if 'breaking_changes' in result:
                  for change in result['breaking_changes']:
                      print(f'  - Consumer: {change.get(\"consumer_id\", \"unknown\")}')
                      print(f'    Affected endpoints: {change.get(\"affected_endpoints\", [])}')
                      print()
          else:
              print('No breaking changes detected - safe to deploy')

          print('=' * 60)
          print()
          print('Full result:')
          print(json.dumps(result, indent=2, default=str))

          validator.close()

          # Exit with error if not safe to deploy (to demonstrate the check works)
          if not result.get('safe_to_deploy', True):
              print()
              print('Deployment blocked due to breaking changes!')
              exit(1)
          " 2>&1 | tee ../demo.log

          # Capture exit code but don't fail the workflow
          EXIT_CODE=$?
          cd ..

          if [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "can-i-deploy correctly detected breaking changes and blocked deployment"
            echo "EXIT_CODE=$EXIT_CODE" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "can-i-deploy indicated safe to deploy"
            echo "EXIT_CODE=0" >> $GITHUB_OUTPUT
          fi

      - name: Generate Job Summary
        if: always()
        run: |
          if [ "${{ steps.demo.outputs.EXIT_CODE }}" != "0" ]; then
            RESULT_EMOJI="ðŸš«"
            RESULT_TEXT="**BLOCKED** - Breaking changes detected!"
          else
            RESULT_EMOJI="âœ…"
            RESULT_TEXT="**SAFE** - No breaking changes"
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Can-I-Deploy Demo

          This workflow demonstrates CVT's breaking change detection capability.

          ### Result: ${RESULT_EMOJI} ${RESULT_TEXT}

          ### Scenario

          1. **Consumers register** their API usage patterns with CVT
             - consumer-1 (Node.js) uses \`result\` field in \`/add\` and \`/subtract\`
             - consumer-2 (Python) uses \`result\` field in \`/add\`, \`/multiply\`, and \`/divide\`
          2. **Producer proposes v2.0.0** which renames \`result\` â†’ \`value\` in responses
          3. **CVT checks** if the change is safe to deploy
          4. **Result**: CVT detected the breaking change and blocked deployment

          ### Why This Matters

          Without CVT, this breaking change could reach production and break both consumers.
          CVT catches this at CI time, before any code is deployed.

          <details>
          <summary>ðŸ“‹ Can-I-Deploy Output</summary>

          \`\`\`
          EOF
          cat demo.log >> $GITHUB_STEP_SUMMARY || echo "Demo output not available" >> $GITHUB_STEP_SUMMARY
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ```

          </details>
          EOF
