name: Can-I-Deploy Demo

on:
  workflow_dispatch:

jobs:
  breaking-change-demo:
    name: Breaking Change Detection
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      cvt-server:
        image: ghcr.io/${{ github.repository_owner }}/cvt-server:0.1.0-alpha.1
        ports:
          - 9550:9550
        options: >-
          --health-cmd "/bin/grpc_health_probe -addr=:9550"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout cvt-demo
        uses: actions/checkout@v4

      - name: Checkout CVT SDK
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/cvt
          path: cvt
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.6'
          cache: true
          cache-dependency-path: producer/go.sum

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: consumer-1/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Setup CVT SDK path
        run: |
          # Create symlink for local dependencies to resolve CVT SDK
          ln -s $GITHUB_WORKSPACE/cvt $GITHUB_WORKSPACE/../cvt 2>/dev/null || true

      - name: Build CVT Tools
        run: |
          # Build CVT CLI
          cd cvt/cmd/cvt
          go build -o $GITHUB_WORKSPACE/bin/cvt .
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH

          # Build CVT Node SDK
          cd ../../sdks/node
          npm ci
          npm run build

      - name: Install Consumer-1 Dependencies
        run: |
          cd consumer-1
          npm ci

      - name: Install Consumer-2 Dependencies
        run: |
          cd consumer-2
          uv sync --extra dev --extra cvt

      - name: Wait for CVT Server
        run: cvt wait --server localhost:9550 --timeout 60

      - name: Step 1 - Register Consumers
        id: register
        run: |
          echo "============================================"
          echo "Step 1: Registering consumers with CVT"
          echo "============================================"
          echo ""

          # Run consumer registration tests to register their endpoint usage
          echo "Registering consumer-1 (Node.js)..."
          cd consumer-1 && CVT_ENVIRONMENT=demo npm test -- --testPathPattern=registration --silent 2>&1 || true
          cd ..

          echo ""
          echo "Registering consumer-2 (Python)..."
          cd consumer-2 && CVT_ENVIRONMENT=demo uv run pytest tests/test_registration.py -v 2>&1 || true
          cd ..

          echo ""
          echo "Consumers registered successfully!"

      - name: Step 2 - Register Breaking Schema v2.0.0
        id: register_v2
        run: |
          echo "============================================"
          echo "Step 2: Registering breaking schema v2.0.0"
          echo "============================================"
          echo ""
          echo "The v2.0.0 schema changes 'result' field to 'value'"
          echo ""
          cvt register-schema calculator-api producer/calculator-api-v2-breaking.yaml --version 2.0.0

      - name: Step 3 - Can I Deploy Check
        id: demo
        run: |
          echo "============================================"
          echo "Step 3: Running can-i-deploy check"
          echo "============================================"
          echo ""
          echo "Checking if calculator-api v2.0.0 can be deployed to 'demo' environment..."
          echo ""

          # Run can-i-deploy and capture output
          set +e
          cvt can-i-deploy --schema calculator-api --version 2.0.0 --env demo 2>&1 | tee demo.log
          EXIT_CODE=${PIPESTATUS[0]}
          set -e

          if [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "can-i-deploy correctly detected breaking changes and blocked deployment"
            echo "EXIT_CODE=$EXIT_CODE" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "can-i-deploy indicated safe to deploy"
            echo "EXIT_CODE=0" >> $GITHUB_OUTPUT
          fi

      - name: Generate Job Summary
        if: always()
        run: |
          if [ "${{ steps.demo.outputs.EXIT_CODE }}" != "0" ]; then
            RESULT_EMOJI="ðŸš«"
            RESULT_TEXT="**BLOCKED** - Breaking changes detected!"
          else
            RESULT_EMOJI="âœ…"
            RESULT_TEXT="**SAFE** - No breaking changes"
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Can-I-Deploy Demo

          This workflow demonstrates CVT's breaking change detection capability.

          ### Result: ${RESULT_EMOJI} ${RESULT_TEXT}

          ### Scenario

          1. **Consumers register** their API usage patterns with CVT
             - consumer-1 (Node.js) uses \`result\` field in \`/add\` and \`/subtract\`
             - consumer-2 (Python) uses \`result\` field in \`/add\`, \`/multiply\`, and \`/divide\`
          2. **Producer proposes v2.0.0** which renames \`result\` â†’ \`value\` in responses
          3. **CVT checks** if the change is safe to deploy
          4. **Result**: CVT detected the breaking change and blocked deployment

          ### Why This Matters

          Without CVT, this breaking change could reach production and break both consumers.
          CVT catches this at CI time, before any code is deployed.

          <details>
          <summary>ðŸ“‹ Can-I-Deploy Output</summary>

          \`\`\`
          EOF
          cat demo.log >> $GITHUB_STEP_SUMMARY || echo "Demo output not available" >> $GITHUB_STEP_SUMMARY
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ```

          </details>
          EOF
