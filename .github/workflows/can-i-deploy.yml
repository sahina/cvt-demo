name: Can-I-Deploy Demo

# Demo modes:
#   - breaking (default): Register v2.0.0 schema with breaking changes -> workflow FAILS
#   - compatible: Register v1.0.0 compatible schema -> workflow PASSES
#
# Run via CLI:
#   gh workflow run "Can-I-Deploy Demo"                              # fails (breaking)
#   gh workflow run "Can-I-Deploy Demo" -f demo_mode=compatible      # passes

on:
  workflow_dispatch:
    inputs:
      demo_mode:
        description: 'Demo mode'
        required: true
        default: 'breaking'
        type: choice
        options:
          - breaking
          - compatible

jobs:
  breaking-change-demo:
    name: Breaking Change Detection
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      cvt-server:
        image: ghcr.io/${{ github.repository_owner }}/cvt:0.3.0
        ports:
          - 9550:9550
        options: >-
          --health-cmd "/bin/grpc_health_probe -addr=:9550"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout cvt-demo
        uses: actions/checkout@v4

      - name: Setup CVT
        uses: ./.github/actions/setup-cvt

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'
          cache: true
          cache-dependency-path: |
            producer/go.sum
            consumer-4/go.sum

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install Consumer-1 Dependencies
        run: |
          cd consumer-1
          npm install

      - name: Install Consumer-2 Dependencies
        run: |
          cd consumer-2
          uv sync --extra dev --extra cvt

      - name: Wait for CVT Server
        run: cvt wait --server localhost:9550 --timeout 60

      - name: Register Consumers
        run: |
          cd consumer-1 && CVT_ENVIRONMENT=demo npm test -- --testPathPatterns=registration --silent 2>&1
          cd ../consumer-2 && CVT_ENVIRONMENT=demo uv run pytest tests/test_registration.py -v 2>&1
          cd ../consumer-3 && CVT_ENVIRONMENT=demo CVT_SERVER_ADDR=localhost:9550 SCHEMA_PATH=../producer/calculator-api.json mvn test -Dtest="RegistrationTest" -q 2>&1
          cd ../consumer-4 && CVT_ENVIRONMENT=demo CVT_SERVER_ADDR=localhost:9550 SCHEMA_PATH=../producer/calculator-api.json go test ./tests/... -run TestRegistration -v 2>&1

      - name: Register Schema
        run: |
          if [ "${{ inputs.demo_mode }}" = "compatible" ]; then
            echo "Registering compatible schema v1.0.0"
            cvt register-schema calculator-api producer/calculator-api.yaml --version 1.0.0
          else
            echo "Registering breaking schema v2.0.0 (renames 'result' to 'value')"
            cvt register-schema calculator-api producer/calculator-api-v2-breaking.yaml --version 2.0.0
          fi

      - name: Can I Deploy Check
        id: demo
        run: |
          VERSION=${{ inputs.demo_mode == 'compatible' && '1.0.0' || '2.0.0' }}
          set +e
          cvt can-i-deploy --schema calculator-api --version $VERSION --env demo 2>&1 | tee demo.log
          EXIT_CODE=${PIPESTATUS[0]}
          echo "EXIT_CODE=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE

      - name: Generate Job Summary
        if: always()
        run: |
          if [ "${{ steps.demo.outputs.EXIT_CODE }}" != "0" ]; then
            RESULT_EMOJI="ðŸš«"
            RESULT_TEXT="**BLOCKED** - Breaking changes detected!"
          else
            RESULT_EMOJI="âœ…"
            RESULT_TEXT="**SAFE** - No breaking changes"
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Can-I-Deploy Demo

          This workflow demonstrates CVT's breaking change detection capability.

          ### Result: ${RESULT_EMOJI} ${RESULT_TEXT}

          ### Scenario

          1. **Consumers register** their API usage patterns with CVT
             - consumer-1 (Node.js) uses \`result\` field in \`/add\` and \`/subtract\`
             - consumer-2 (Python) uses \`result\` field in \`/add\`, \`/multiply\`, and \`/divide\`
             - consumer-3 (Java) uses \`result\` field in \`/multiply\` and \`/divide\`
             - consumer-4 (Go) uses \`result\` field in \`/add\` and \`/subtract\`
          2. **Producer proposes v2.0.0** which renames \`result\` â†’ \`value\` in responses
          3. **CVT checks** if the change is safe to deploy
          4. **Result**: CVT detected the breaking change and blocked deployment

          ### Why This Matters

          Without CVT, this breaking change could reach production and break both consumers.
          CVT catches this at CI time, before any code is deployed.

          <details>
          <summary>ðŸ“‹ Can-I-Deploy Output</summary>

          \`\`\`
          EOF
          cat demo.log >> $GITHUB_STEP_SUMMARY || echo "Demo output not available" >> $GITHUB_STEP_SUMMARY
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ```

          </details>
          EOF
