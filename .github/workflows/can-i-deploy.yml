name: Can-I-Deploy Demo

# Demo modes:
#   - breaking (default): Register v2.0.0 schema with breaking changes -> workflow FAILS
#   - compatible: Register v1.0.0 compatible schema -> workflow PASSES
#
# Run via CLI:
#   gh workflow run "Can-I-Deploy Demo"                              # fails (breaking)
#   gh workflow run "Can-I-Deploy Demo" -f demo_mode=compatible      # passes

on:
  workflow_dispatch:
    inputs:
      demo_mode:
        description: 'Demo mode'
        required: true
        default: 'breaking'
        type: choice
        options:
          - breaking
          - compatible

jobs:
  breaking-change-demo:
    name: Breaking Change Detection
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      cvt-server:
        image: ghcr.io/${{ github.repository_owner }}/cvt-server:0.1.0-alpha.1
        ports:
          - 9550:9550
        options: >-
          --health-cmd "/bin/grpc_health_probe -addr=:9550"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout cvt-demo
        uses: actions/checkout@v4

      - name: Checkout CVT SDK
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/cvt
          path: cvt
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.6'
          cache: true
          cache-dependency-path: producer/go.sum

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: consumer-1/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Setup CVT SDK path
        run: |
          # Create symlink for local dependencies to resolve CVT SDK
          ln -s $GITHUB_WORKSPACE/cvt $GITHUB_WORKSPACE/../cvt 2>/dev/null || true

      - name: Build CVT Tools
        run: |
          # Build CVT CLI
          mkdir -p $GITHUB_WORKSPACE/bin
          cd cvt/cmd/cvt
          go build -o $GITHUB_WORKSPACE/bin/cvt .
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH

          # Build CVT Node SDK
          cd ../../sdks/node
          npm ci
          npm run build

      - name: Install Consumer-1 Dependencies
        run: |
          cd consumer-1
          npm ci

      - name: Install Consumer-2 Dependencies
        run: |
          cd consumer-2
          uv sync --extra dev --extra cvt

      - name: Wait for CVT Server
        run: cvt wait --server localhost:9550 --timeout 60

      - name: Step 1 - Register Consumers
        run: |
          echo "============================================"
          echo "Step 1: Registering consumers with CVT"
          echo "============================================"
          echo ""
          echo "Consumers declare which API endpoints and fields they use."
          echo "This information is stored in CVT for breaking change detection."
          echo ""

          echo "Registering consumer-1 (Node.js)..."
          echo "  - Uses: /add, /subtract"
          echo "  - Fields: result"
          cd consumer-1 && CVT_ENVIRONMENT=demo npm test -- --testPathPattern=registration --silent 2>&1 || true
          cd ..

          echo ""
          echo "Registering consumer-2 (Python)..."
          echo "  - Uses: /add, /multiply, /divide"
          echo "  - Fields: result"
          cd consumer-2 && CVT_ENVIRONMENT=demo uv run pytest tests/test_registration.py -v 2>&1 || true
          cd ..

          echo ""
          echo "Consumers registered successfully!"

      - name: Step 2 - Register Schema
        run: |
          echo "============================================"
          echo "Step 2: Registering producer schema with CVT"
          echo "============================================"
          echo ""

          if [ "${{ inputs.demo_mode }}" = "compatible" ]; then
            echo "Mode: compatible"
            echo "Registering schema v1.0.0 (no breaking changes)"
            echo "This schema uses the 'result' field that consumers expect."
            echo ""
            cvt register-schema calculator-api producer/calculator-api.yaml --version 1.0.0
          else
            echo "Mode: breaking"
            echo "Registering schema v2.0.0 with BREAKING CHANGE"
            echo "This schema renames 'result' field to 'value'"
            echo "Consumers still expect 'result' - this will break them!"
            echo ""
            cvt register-schema calculator-api producer/calculator-api-v2-breaking.yaml --version 2.0.0
          fi

          echo ""
          echo "Schema registered successfully!"

      - name: Step 3 - Can I Deploy Check
        id: demo
        run: |
          echo "============================================"
          echo "Step 3: Running can-i-deploy check"
          echo "============================================"
          echo ""

          VERSION=${{ inputs.demo_mode == 'compatible' && '1.0.0' || '2.0.0' }}
          echo "Checking if calculator-api v$VERSION can be deployed to 'demo' environment..."
          echo ""
          echo "CVT will compare the schema against registered consumer expectations."
          echo ""

          set +e
          cvt can-i-deploy --schema calculator-api --version $VERSION --env demo 2>&1 | tee demo.log
          EXIT_CODE=${PIPESTATUS[0]}
          echo "EXIT_CODE=$EXIT_CODE" >> $GITHUB_OUTPUT

          echo ""
          if [ $EXIT_CODE -ne 0 ]; then
            echo "============================================"
            echo "RESULT: Deployment BLOCKED"
            echo "============================================"
            echo "CVT detected breaking changes that would affect consumers."
          else
            echo "============================================"
            echo "RESULT: Safe to deploy"
            echo "============================================"
            echo "No breaking changes detected."
          fi

          exit $EXIT_CODE

      - name: Generate Job Summary
        if: always()
        run: |
          if [ "${{ steps.demo.outputs.EXIT_CODE }}" != "0" ]; then
            RESULT_EMOJI="ðŸš«"
            RESULT_TEXT="**BLOCKED** - Breaking changes detected!"
          else
            RESULT_EMOJI="âœ…"
            RESULT_TEXT="**SAFE** - No breaking changes"
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Can-I-Deploy Demo

          This workflow demonstrates CVT's breaking change detection capability.

          ### Result: ${RESULT_EMOJI} ${RESULT_TEXT}

          ### Scenario

          1. **Consumers register** their API usage patterns with CVT
             - consumer-1 (Node.js) uses \`result\` field in \`/add\` and \`/subtract\`
             - consumer-2 (Python) uses \`result\` field in \`/add\`, \`/multiply\`, and \`/divide\`
          2. **Producer proposes v2.0.0** which renames \`result\` â†’ \`value\` in responses
          3. **CVT checks** if the change is safe to deploy
          4. **Result**: CVT detected the breaking change and blocked deployment

          ### Why This Matters

          Without CVT, this breaking change could reach production and break both consumers.
          CVT catches this at CI time, before any code is deployed.

          <details>
          <summary>ðŸ“‹ Can-I-Deploy Output</summary>

          \`\`\`
          EOF
          cat demo.log >> $GITHUB_STEP_SUMMARY || echo "Demo output not available" >> $GITHUB_STEP_SUMMARY
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ```

          </details>
          EOF
