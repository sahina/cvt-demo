name: Tests

# CVT Contract Testing Workflow
#
# This workflow runs all contract tests for the CVT demo application:
#
# Producer Tests (Go):
#   - Compliance: Validates handler responses against OpenAPI schema
#   - Middleware: Tests Strict/Warn/Shadow validation modes
#   - Registry: Tests consumer registration and can-i-deploy checks
#   - Integration: Full HTTP tests against running producer with CVT
#
# Consumer Tests:
#   - Mock Tests: Schema-generated responses without real HTTP calls (CVT server only)
#   - Live Tests: Real HTTP calls to producer with contract validation
#
# All tests run with continue-on-error to provide full coverage report.
# Results are displayed as a checklist in the GitHub Actions job summary.
#
# Run via CLI:
#   gh workflow run "Tests"

on:
  workflow_dispatch:

jobs:
  all-tests:
    name: All Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      cvt-server:
        image: ghcr.io/${{ github.repository_owner }}/cvt-server:0.1.0-alpha.1
        ports:
          - 9550:9550
        options: >-
          --health-cmd "/bin/grpc_health_probe -addr=:9550"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup CVT
        uses: ./.github/actions/setup-cvt
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          go-cache-dependency-path: producer/go.sum
          build-node-sdk: 'true'
          node-cache-dependency-path: consumer-1/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install Consumer-1 Dependencies
        run: |
          cd consumer-1
          npm ci

      - name: Install Consumer-2 Dependencies
        run: |
          cd consumer-2
          uv sync --extra dev --extra cvt

      - name: Update Go modules
        run: |
          cd producer
          go mod tidy

      - name: Wait for CVT Server
        run: cvt wait --server localhost:9550 --timeout 60

      # Producer Tests (before starting producer)
      - name: Run Compliance Tests
        id: compliance
        continue-on-error: true
        run: cd producer && go test ./tests/... -run Compliance -v

      - name: Run Middleware Tests
        id: middleware
        continue-on-error: true
        run: cd producer && go test ./tests/... -run Middleware -v

      - name: Run Registry Tests
        id: registry
        continue-on-error: true
        run: cd producer && go test ./tests/... -run Registry -v

      # Start Producer
      - name: Build and Start Producer
        run: |
          cd producer
          go build -o calculator-api .
          PORT=10001 CVT_SERVER_ADDR=localhost:9550 SCHEMA_PATH=./calculator-api.yaml CVT_ENABLED=true ./calculator-api &
          echo $! > /tmp/producer.pid

      - name: Wait for Producer
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:10001/health; then
              echo ""
              echo "Producer is ready"
              exit 0
            fi
            echo "Waiting for producer... ($i/30)"
            sleep 2
          done
          echo "Producer failed to start"
          exit 1

      # Producer Integration Tests
      - name: Run Integration Tests
        id: integration
        continue-on-error: true
        run: cd producer && go test ./tests/... -run Integration -v

      # Consumer-1 Tests
      - name: Consumer-1 Mock Tests
        id: consumer1_mock
        continue-on-error: true
        run: cd consumer-1 && npm test -- --testPathPattern=mock

      - name: Consumer-1 Live Tests
        id: consumer1_live
        continue-on-error: true
        run: cd consumer-1 && npm test -- --testPathPattern="(adapter|manual)"

      # Consumer-2 Tests
      - name: Consumer-2 Mock Tests
        id: consumer2_mock
        continue-on-error: true
        run: cd consumer-2 && uv run pytest tests/test_mock.py -v

      - name: Consumer-2 Live Tests
        id: consumer2_live
        continue-on-error: true
        run: cd consumer-2 && uv run pytest tests/test_adapter.py tests/test_manual.py -v

      # Cleanup
      - name: Stop Producer
        id: cleanup
        if: always()
        run: |
          if [ -f /tmp/producer.pid ]; then
            kill $(cat /tmp/producer.pid) 2>/dev/null && echo "Producer stopped" || echo "Already stopped"
          fi

      # Summary
      - name: Generate Job Summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Producer Tests" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.compliance.outcome }}" = "success" ] && echo "- ✅ Compliance" >> $GITHUB_STEP_SUMMARY || echo "- ❌ Compliance" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.middleware.outcome }}" = "success" ] && echo "- ✅ Middleware" >> $GITHUB_STEP_SUMMARY || echo "- ❌ Middleware" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.registry.outcome }}" = "success" ] && echo "- ✅ Registry" >> $GITHUB_STEP_SUMMARY || echo "- ❌ Registry" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.integration.outcome }}" = "success" ] && echo "- ✅ Integration" >> $GITHUB_STEP_SUMMARY || echo "- ❌ Integration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Consumer-1 (Node.js)" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.consumer1_mock.outcome }}" = "success" ] && echo "- ✅ Mock" >> $GITHUB_STEP_SUMMARY || echo "- ❌ Mock" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.consumer1_live.outcome }}" = "success" ] && echo "- ✅ Live" >> $GITHUB_STEP_SUMMARY || echo "- ❌ Live" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Consumer-2 (Python)" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.consumer2_mock.outcome }}" = "success" ] && echo "- ✅ Mock" >> $GITHUB_STEP_SUMMARY || echo "- ❌ Mock" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.consumer2_live.outcome }}" = "success" ] && echo "- ✅ Live" >> $GITHUB_STEP_SUMMARY || echo "- ❌ Live" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cleanup" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.cleanup.outcome }}" = "success" ] && echo "- ✅ Producer stopped" >> $GITHUB_STEP_SUMMARY || echo "- ❌ Cleanup failed" >> $GITHUB_STEP_SUMMARY

      - name: Check for failures
        if: always()
        run: |
          if [ "${{ steps.compliance.outcome }}" != "success" ] || \
             [ "${{ steps.middleware.outcome }}" != "success" ] || \
             [ "${{ steps.registry.outcome }}" != "success" ] || \
             [ "${{ steps.integration.outcome }}" != "success" ] || \
             [ "${{ steps.consumer1_mock.outcome }}" != "success" ] || \
             [ "${{ steps.consumer1_live.outcome }}" != "success" ] || \
             [ "${{ steps.consumer2_mock.outcome }}" != "success" ] || \
             [ "${{ steps.consumer2_live.outcome }}" != "success" ]; then
            echo "One or more tests failed"
            exit 1
          fi
